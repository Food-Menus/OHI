<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الملف الشخصي - October High Institute</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="./اساسيات/Logo_OHI_min.png" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .sidebar {
            width: 250px;
            height: 100%;
            position: fixed;
            top: 0;
            right: -250px;
            background-color: #2c3e50;
            color: white;
            transition: right 0.3s;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .sidebar.active {
            right: 0;
        }
        
        .sidebar-logo {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.5rem;
        }
        
        .sidebar-menus {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .sidebar-menus a {
            color: white;
            text-decoration: none;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        .sidebar-menus a:hover {
            background-color: #34495e;
        }
        
        .menu-off {
            background-color: #e74c3c;
        }
        
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 100;
        }
        
        .menu-toggle {
            cursor: pointer;
        }
        
        .header-logo {
            height: 50px;
        }
        
        .user svg {
            color: #2c3e50;
        }
        
        .main-content {
            padding: 20px;
            margin-top: 20px;
            min-height: calc(100vh - 160px);
        }
        
        .section__header {
            text-align: center;
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        .profile-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .profile-item {
            margin-bottom: 15px;
        }
        
        .profile-label {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .profile-value {
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        
        .courses-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .courses-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .courses-table th {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            text-align: right;
        }
        
        .courses-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            text-align: right;
            vertical-align: top;
        }
        
        .courses-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .courses-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        
        .courses-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .courses-list li:last-child {
            border-bottom: none;
        }
        
        .course-code {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .no-courses {
            text-align: center;
            color: #7f8c8d;
            padding: 20px;
        }
        
        .error-message {
            text-align: center;
            color: #e74c3c;
            padding: 20px;
        }
        
        .logout-btn {
            width: 100%;
            padding: 10px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-top: 20px;
            text-align: center;
            text-decoration: none;
        }
        .logout-btnn {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #59bc5f;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-top: 20px;
            text-align: center;
            text-decoration: none;
        }
        
        .logout-btn:hover {
            background-color: #c0392b;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 14px;
        }
    </style>
</head>

<body>
    
    <div class="sidebar">
        <h2 class="sidebar-logo">October High Institute</h2>
        <div class="sidebar-menus">
            <a href="https://www.facebook.com/ohinstitute">الصفحة الرسمية</a>
            <a href="https://www.ohi.edu.eg/default.aspx">الموقع الرسمي</a>
            <a href="https://wa.me/+201102716716?text=مرحبا اريد التواصل معكم">الدعم الفني</a>
            <a href="./about.html">من نحن</a>
            <a href="#" class="menu-off">إغلاق</a>
        </div>
    </div>

    <div class="navbar">
        <div class="menu-toggle">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                <path d="M5 5H13V19H5V5ZM19 19H15V5H19V19ZM4 3C3.44772 3 3 3.44772 3 4V20C3 20.5523 3.44772 21 4 21H20C20.5523 21 21 20.5523 21 20V4C21 3.44772 20.5523 3 20 3H4ZM7 12L11 8.5V15.5L7 12Z"></path>
            </svg>
        </div>
        <img class="header-logo" src="./اساسيات/logo.jpg" alt="شعار المعهد">
        <a href="./index.html" class="user">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="36" height="36" fill="currentColor"><path d="M12 2C17.52 2 22 6.48 22 12C22 17.52 17.52 22 12 22C6.48 22 2 17.52 2 12C2 6.48 6.48 2 12 2ZM12 20C16.42 20 20 16.42 20 12C20 7.58 16.42 4 12 4C7.58 4 4 7.58 4 12C4 16.42 7.58 20 12 20ZM12 11H16V13H12V16L8 12L12 8V11Z"></path></svg>
        </a>
    </div>

    <div class="main-content">
        <h2 class="section__header">الملف الشخصي</h2>
        
        <div class="profile-container">
            <div id="userData" class="profile-info">
                <!-- سيتم ملء البيانات هنا بواسطة الجافاسكربت -->
            </div>
            
            <div class="courses-section">
                <h3>المواد المسجلة</h3>
                <div id="coursesData">
                    <!-- سيتم ملء بيانات المواد هنا -->
                </div>
            </div>
            
            <a href="#" id="logoutBtn" class="logout-btn">    <button id="logoutButton" class="logout-btn">  تسجيل الخروج  </button><br>            </a>

        </div>
        
        <div class="footer">
            <p> ©2025 حقوق النشر طلاب معهد اكتوبر العالي للهندسة</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // التحقق من وجود بيانات تسجيل دخول
            const storedEmail = localStorage.getItem('email');
            const storedPassword = localStorage.getItem('password');
            
            if (!storedEmail || !storedPassword) {
                Swal.fire({
                    title: 'غير مصرح بالدخول',
                    text: 'يجب عليك تسجيل الدخول أولاً للوصول إلى هذه الصفحة',
                    icon: 'error'
                }).then(() => {
                    window.location.href = 'index.html';
                });
                return;
            }
            
            // عناوين جداول البيانات
            const userDataUrl = 'https://docs.google.com/spreadsheets/d/1eAUNv-OksaLsAbuCNWr5_vrkaAEW15TxBLI7HcXHoxE/gviz/tq?tqx=out:json';
            const coursesDataUrl = 'https://docs.google.com/spreadsheets/d/1HfAOMxRMHjqfGHKVWgTPQRq_TX-MmXe6uvCC8yy7Tfg/gviz/tq?tqx=out:json';
            
            let userPhone = '';
            
            // جلب بيانات المستخدم الأساسية
            fetch(userDataUrl)
                .then(response => response.text())
                .then(data => {
                    const jsonData = JSON.parse(data.substr(47).slice(0, -2));
                    const rows = jsonData.table.rows;
                    
                    let userData = null;
                    
                    // البحث عن بيانات المستخدم الحالي
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        const email = row.c[4]?.v;
                        const password = row.c[1]?.v;
                        
                        if (email === storedEmail && password === storedPassword) {
                            userData = {
                                username: row.c[0]?.v || 'غير متوفر',
                                phone: row.c[2]?.v || 'غير متوفر',
                                age: row.c[3]?.v || 'غير متوفر',
                                email: email || 'غير متوفر'
                            };
                            userPhone = row.c[2]?.v || '';
                            break;
                        }
                    }
                    
                    if (userData) {
                        // عرض بيانات المستخدم
                        const profileHtml = `
                            <div class="profile-item">
                                <div class="profile-label">اسم المستخدم:</div>
                                <div class="profile-value">${userData.username}</div>
                            </div>
                            <div class="profile-item">
                                <div class="profile-label">البريد الإلكتروني:</div>
                                <div class="profile-value">${userData.email}</div>
                            </div>
                            <div class="profile-item">
                                <div class="profile-label">رقم الهاتف:</div>
                                <div class="profile-value">${userData.phone}</div>
                            </div>
                            <div class="profile-item">
                                <div class="profile-label">العمر:</div>
                                <div class="profile-value">${userData.age}</div>
                            </div>
                        `;
                        
                        document.getElementById('userData').innerHTML = profileHtml;
                        
                        // جلب بيانات المواد المسجلة إذا كان هناك رقم هاتف
                        if (userPhone) {
                            fetchCoursesData(userPhone);
                        }
                    } else {
                        Swal.fire({
                            title: 'خطأ في البيانات',
                            text: 'لم يتم العثور على بيانات المستخدم. يرجى تسجيل الدخول مرة أخرى.',
                            icon: 'error'
                        }).then(() => {
                            localStorage.removeItem('email');
                            localStorage.removeItem('password');
                            window.location.href = 'index.html';
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching user data:', error);
                    Swal.fire({
                        title: 'خطأ في الاتصال',
                        text: 'حدث خطأ أثناء جلب بيانات المستخدم. يرجى المحاولة مرة أخرى لاحقاً.',
                        icon: 'error'
                    });
                });
            
            // دالة لجلب وعرض المواد المسجلة
            function fetchCoursesData(phone) {
                fetch(coursesDataUrl)
                    .then(response => response.text())
                    .then(data => {
                        const jsonData = JSON.parse(data.substr(47).slice(0, -2));
                        const rows = jsonData.table.rows;
                        
                        let courses = [];
                        
                        // البحث عن المواد المسجلة للطالب
                        for (let i = 0; i < rows.length; i++) {
                            const row = rows[i];
                            const rowPhone = row.c[0]?.v;
                            
                            if (rowPhone === phone) {
                                // تحويل سلسلة المواد إلى مصفوفة
                                let coursesArray = [];
                                try {
                                    const rawCourses = row.c[4]?.v;
                                    if (rawCourses) {
                                        // معالجة النص ليكون صيغة JSON صحيحة
                                        const fixedJson = rawCourses
                                            .replace(/'/g, '"') // استبدال الاقتباس المفرد بمزدوج
                                            .replace(/(\w+):/g, '"$1":'); // إضافة اقتباسات حول المفاتيح
                                            
                                        coursesArray = JSON.parse(fixedJson);
                                    }
                                } catch (e) {
                                    console.error('Error parsing courses:', e);
                                    // إذا فشل التحليل، نعرضها كنص عادي
                                    coursesArray = [row.c[4]?.v || 'غير معروف'];
                                }
                                
                                courses.push({
                                    specialization: row.c[1]?.v || 'غير محدد',
                                    year: row.c[2]?.v || 'غير محدد',
                                    semester: row.c[3]?.v || 'غير محدد',
                                    courses: coursesArray,
                                    timestamp: row.c[5]?.v || 'غير محدد'
                                });
                            }
                        }
                        
                        // عرض المواد المسجلة
                        if (courses.length > 0) {
                            let coursesHtml = '<table class="courses-table">';
                            coursesHtml += `
                                <thead>
                                    <tr>
                                        <th>التخصص</th>
                                        <th>السنة</th>
                                        <th>الفصل الدراسي</th>
                                        <th>المواد المسجلة</th>
                                        <th>تاريخ التسجيل</th>
                                    </tr>
                                </thead>
                                <tbody>
                            `;
                            
                            courses.forEach(course => {
                                // إنشاء قائمة مرتبة للمواد
                                let coursesListHtml = '<ul class="courses-list">';
                                
                                // التأكد أن courses هي مصفوفة
                                const courseItems = Array.isArray(course.courses) ? course.courses : [course.courses];
                                
                                courseItems.forEach(c => {
                                    if (c) {
                                        // تقسيم اسم المادة ورمزها إذا كانا متاحين
                                        const courseParts = String(c).split('|');
                                        const courseName = courseParts[0] || c;
                                        const courseCode = courseParts[1] || '';
                                        
                                        coursesListHtml += `
                                            <li>
                                                <span>${courseName.trim()}</span>
                                                ${courseCode ? `<span class="course-code">${courseCode.trim()}</span>` : ''}
                                            </li>
                                        `;
                                    }
                                });
                                coursesListHtml += '</ul>';
                                
                                coursesHtml += `
                                    <tr>
                                        <td>${course.specialization}</td>
                                        <td>${course.year}</td>
                                        <td>${course.semester}</td>
                                        <td>${coursesListHtml}</td>
                                        <td>${course.timestamp}</td>
                                    </tr>
                                `;
                            });
                            
                            coursesHtml += '</tbody></table>';
                            document.getElementById('coursesData').innerHTML = coursesHtml;
                        } else {
                            document.getElementById('coursesData').innerHTML = 
                            ' <a href="./Material_registration.html" id="logoutBtn" class="logout-btnn">تسجيل المواد  </a>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching courses data:', error);
                        document.getElementById('coursesData').innerHTML = 
                            '<p class="error-message">حدث خطأ أثناء جلب بيانات المواد المسجلة</p>';
                    });
            }
            
            // تسجيل الخروج
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('email');
                localStorage.removeItem('password');
                Swal.fire({
                    title: 'تم تسجيل الخروج',
                    text: 'سيتم تحويلك إلى صفحة تسجيل الدخول...',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = 'index.html';
                });
            });
            
            // تفعيل القائمة الجانبية
            document.querySelector('.menu-toggle').addEventListener('click', function() {
                document.querySelector('.sidebar').classList.toggle('active');
            });
            
            document.querySelector('.menu-off').addEventListener('click', function() {
                document.querySelector('.sidebar').classList.remove('active');
            });
        });



        document.addEventListener('DOMContentLoaded', () => {
            const email = localStorage.getItem('email');
            if (!email) {
                window.location.href = './auth.html';
            } else {
                document.getElementById('email').textContent = email;
            }
        });
        


        
        const logoutButton = document.getElementById('logoutButton');
        if(logoutButton) {
            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('username');
                localStorage.removeItem('password');
                localStorage.removeItem('email');
                window.location.href = './index.html';
                swal("تم تسجيل الخروج", "تم تسجيل الخروج بنجاح.", "success");
            });
        }
    </script>
</body>
</html>